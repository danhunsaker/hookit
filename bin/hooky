#!/usr/bin/env ruby

MODULE_DIR = "/opt/local/hooky/mod"
LOG_LEVEL  = :error
LOGFILE    = '/var/log/hooky/hooky.log'

hook = ARGV.shift

if not hook
  $stderr.puts "hook is required"
  exit 1
end

# uncomment if dev only
# lib = File.expand_path('../../lib', __FILE__)
# $LOAD_PATH.unshift(lib) unless $LOAD_PATH.include?(lib)

require 'hooky'
require 'json'

include Hooky::Hook   # payload helpers
include Hooky::DSL    # awesome resource library

set :log_level,   LOG_LEVEL
set :logfile,     LOGFILE
set :module_root, MODULE_DIR

# require hook libs
Dir.glob("#{MODULE_DIR}/lib/*.rb").each do |file|
  require file
end

logger.info ""
logger.info "hook: #{hook}"
logger.info "payload: #{payload.to_json}"

begin
  load "#{MODULE_DIR}/hooks/#{hook}.rb"
rescue LoadError
  logger.error "hook: #{hook} does not exist"
  $stderr.puts "hook: #{hook} does not exist"
end
