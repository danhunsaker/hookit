#!/usr/bin/env ruby

HOOKS_DIR = "#{Dir.pwd}/tmp"

hook   = ARGV.shift
mod    = nil
script = nil

if not hook
  $stderr.puts "hook is required"
  exit 1
end

hook.match '(.+)\[(.+)\]' do |m|
  mod    = m[1]
  script = m[2]
end

if not (mod and script)
  $stderr.puts "invalid hook format, expecting: php[default-configure]"
  exit 1
end

if not File.exists? "#{HOOKS_DIR}/#{mod}/hooks/#{script}"
  $stderr.puts "hook: #{hook} does not exist"
end

# TODO: find a way to conditionally trigger this if dev only
lib = File.expand_path('../../lib', __FILE__)
$LOAD_PATH.unshift(lib) unless $LOAD_PATH.include?(lib)

require 'hooky'

include Hooky::Hook   # payload helpers
include Hooky::DSL    # awesome resource library

set :hook_root, "#{HOOKS_DIR}/#{mod}"

# require hook libs
Dir.glob("#{HOOKS_DIR}/#{mod}/lib/*.rb").sort.each do |file|
  require file
end

load "#{HOOKS_DIR}/#{mod}/hooks/#{script}"
